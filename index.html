<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>صيدلية ود المنسي - v2.2</title>
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.rtl.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>

    <style>
        :root {
            --primary-color: #0f9b0f;
            --bg-light: #f4f6f9;
            --card-radius: 16px;
        }

        body {
            background-color: var(--bg-light);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            overflow-x: hidden;
        }

        /* --- Login Screen Styling --- */
        #loginSection {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100vh;
            background: linear-gradient(135deg, #0f9b0f, #004d00);
            z-index: 9999;
            display: flex; /* Default display */
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        /* --- Header & Navigation --- */
        .mobile-header {
            background: white;
            padding: 10px 15px;
            border-radius: 0 0 20px 20px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.05);
            position: sticky;
            top: 0;
            z-index: 1000;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .btn-tool {
            width: 40px; height: 40px;
            border-radius: 50%;
            border: none;
            background: #f8f9fa;
            color: #333;
            display: flex; align-items: center; justify-content: center;
            transition: 0.2s;
        }
        .btn-tool:active { transform: scale(0.9); background: #e2e6ea; }

        .btn-main-add {
            background: var(--primary-color);
            color: white;
            padding: 8px 20px;
            border-radius: 30px;
            font-weight: bold;
            box-shadow: 0 4px 10px rgba(15, 155, 15, 0.3);
            border: none;
        }

        /* --- Stats Grid --- */
        .stat-card {
            background: white;
            border-radius: var(--card-radius);
            padding: 15px;
            height: 100%;
            box-shadow: 0 2px 10px rgba(0,0,0,0.03);
            border-bottom: 4px solid transparent;
            transition: transform 0.2s;
            cursor: pointer;
        }
        .stat-card:active { transform: scale(0.98); }
        
        .border-success { border-bottom-color: #198754 !important; }
        .border-primary { border-bottom-color: #0d6efd !important; }
        .border-danger  { border-bottom-color: #dc3545 !important; }
        .border-warning { border-bottom-color: #ffc107 !important; }

        /* --- Inventory List --- */
        .item-card {
            background: white;
            border-radius: 12px;
            margin-bottom: 10px;
            padding: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.02);
        }
        .badge-qty {
            background: #e9ecef; color: #333;
            padding: 4px 8px; border-radius: 6px; font-weight: bold; font-size: 0.85rem;
        }

        /* --- AI Camera --- */
        .camera-trigger {
            border: 2px dashed #0d6efd;
            background: #f8f9fa;
            color: #0d6efd;
            padding: 20px;
            text-align: center;
            border-radius: 12px;
            position: relative;
        }
        .camera-input {
            position: absolute; top:0; left:0; width:100%; height:100%; opacity:0;
        }

        /* Helper Utility to hide/show */
        .d-none-custom { display: none !important; }
    </style>
</head>
<body>

    <div id="loginSection">
        <div class="card p-4 text-center rounded-4 shadow" style="width: 90%; max-width: 320px;">
            <div class="mb-3 text-success"><i class="fas fa-mortar-pestle fa-3x"></i></div>
            <h4 class="fw-bold mb-1">ود المنسي</h4>
            <small class="text-muted mb-4">نظام إدارة الصيدلية الذكي</small>
            
            <input type="password" id="passInput" class="form-control text-center rounded-pill mb-3" placeholder="أدخل الرمز السري">
            <button onclick="attemptLogin()" class="btn btn-success w-100 rounded-pill fw-bold">تسجيل الدخول</button>
            <p id="loginError" class="text-danger mt-2 small d-none">كلمة المرور غير صحيحة</p>
        </div>
    </div>

    <div id="mainDashboard" class="d-none-custom">
        
        <div class="mobile-header">
            <div class="dropdown">
                <button class="btn-tool" data-bs-toggle="dropdown">
                    <i class="fas fa-cog"></i>
                </button>
                <ul class="dropdown-menu shadow border-0 rounded-3">
                    <li><h6 class="dropdown-header">إدارة البيانات</h6></li>
                    <li><a class="dropdown-item" href="#" onclick="backupData()"><i class="fas fa-download text-success"></i> نسخ احتياطي</a></li>
                    <li><a class="dropdown-item" href="#" onclick="document.getElementById('restoreFile').click()"><i class="fas fa-upload text-primary"></i> استعادة بيانات</a></li>
                    <li><hr class="dropdown-divider"></li>
                    <li><a class="dropdown-item" href="#" onclick="exportExcelReport()"><i class="fas fa-file-excel text-success"></i> تصدير Excel</a></li>
                    <li><a class="dropdown-item text-danger" href="#" onclick="logout()"><i class="fas fa-sign-out-alt"></i> خروج</a></li>
                </ul>
                <input type="file" id="restoreFile" style="display:none" onchange="restoreData(this)" accept=".json">
            </div>

            <h5 class="m-0 fw-bold text-success">ود المنسي</h5>

            <button onclick="openAddModal()" class="btn-main-add">
                <i class="fas fa-plus"></i> إضافة
            </button>
        </div>

        <div class="container-fluid p-3 pb-5">
            <div class="row g-2 mb-3">
                <div class="col-6">
                    <div class="stat-card border-success" onclick="openChartModal('items')">
                        <i class="fas fa-pills text-success fa-2x mb-2 opacity-50"></i>
                        <h6 class="text-muted small mb-1">الأصناف</h6>
                        <h4 class="fw-bold m-0" id="statCount">0</h4>
                    </div>
                </div>
                <div class="col-6">
                    <div class="stat-card border-primary" onclick="openChartModal('value')">
                        <i class="fas fa-coins text-primary fa-2x mb-2 opacity-50"></i>
                        <h6 class="text-muted small mb-1">القيمة</h6>
                        <h5 class="fw-bold m-0" id="statValue">0</h5>
                    </div>
                </div>
                <div class="col-6">
                    <div class="stat-card border-danger" onclick="openChartModal('expiry')">
                        <i class="fas fa-hourglass-half text-danger fa-2x mb-2 opacity-50"></i>
                        <h6 class="text-muted small mb-1">منتهي/قريب</h6>
                        <h4 class="fw-bold m-0 text-danger" id="statExp">0</h4>
                    </div>
                </div>
                <div class="col-6">
                    <div class="stat-card border-warning" onclick="openChartModal('stock')">
                        <i class="fas fa-battery-quarter text-warning fa-2x mb-2 opacity-50"></i>
                        <h6 class="text-muted small mb-1">النواقص</h6>
                        <h4 class="fw-bold m-0 text-warning" id="statLow">0</h4>
                    </div>
                </div>
            </div>

            <div class="input-group shadow-sm rounded-4 overflow-hidden bg-white mb-3">
                <span class="input-group-text bg-white border-0 ps-3"><i class="fas fa-search text-muted"></i></span>
                <input type="text" id="searchInput" onkeyup="renderList()" class="form-control border-0 p-2" placeholder="بحث بالاسم أو المادة الفعالة...">
            </div>

            <div id="inventoryContainer"></div>
        </div>
    </div>

    <div class="modal fade" id="itemModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content rounded-4 border-0">
                <div class="modal-header border-0">
                    <h5 class="modal-title fw-bold">بيانات الدواء</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body pt-0">
                    <div class="camera-trigger mb-3">
                        <i class="fas fa-camera fa-2x mb-2"></i><br>
                        <span>اضغط لتصوير العلبة (AI)</span>
                        <input type="file" class="camera-input" accept="image/*" capture="environment" onchange="handleOCR(this)">
                        <div id="ocrLoading" class="text-primary mt-2 small d-none">جاري قراءة البيانات...</div>
                    </div>

                    <input type="hidden" id="editIndex">
                    <div class="form-floating mb-2">
                        <input type="text" class="form-control" id="inpName" placeholder="الاسم">
                        <label>اسم الدواء</label>
                    </div>
                    <div class="row g-2">
                        <div class="col-6">
                            <div class="form-floating mb-2">
                                <input type="number" class="form-control" id="inpQty" placeholder="الكمية">
                                <label>الكمية</label>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="form-floating mb-2">
                                <input type="number" class="form-control" id="inpPrice" placeholder="السعر">
                                <label>السعر</label>
                            </div>
                        </div>
                    </div>
                    <div class="form-floating mb-2">
                        <input type="date" class="form-control" id="inpExp" placeholder="التاريخ">
                        <label>تاريخ الانتهاء</label>
                    </div>
                    <div class="form-floating">
                        <input type="text" class="form-control" id="inpActive" placeholder="المادة">
                        <label>المادة الفعالة (اختياري)</label>
                    </div>
                </div>
                <div class="modal-footer border-0">
                    <button onclick="saveItem()" class="btn btn-success w-100 rounded-pill py-2 fw-bold">حفظ البيانات</button>
                    <button onclick="deleteItem()" id="btnDelete" class="btn btn-outline-danger w-100 rounded-pill py-2 d-none">حذف</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="chartModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content rounded-4">
                <div class="modal-header border-0">
                    <h5 class="modal-title fw-bold" id="chartTitle">تحليل</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body text-center">
                    <h3 class="text-primary fw-bold mb-3" id="chartMainValue"></h3>
                    <div style="height: 250px;">
                        <canvas id="theChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- 1. System Setup ---
        const SYS_PASS = "123456";
        let db = JSON.parse(localStorage.getItem('wm_db_v22')) || [];
        let chartInstance = null;

        // --- 2. Authentication Logic ---
        function attemptLogin() {
            const pass = document.getElementById('passInput').value;
            if(pass === SYS_PASS) {
                // Hide Login, Show Dashboard strictly
                document.getElementById('loginSection').classList.add('d-none-custom');
                document.getElementById('mainDashboard').classList.remove('d-none-custom');
                refreshUI();
            } else {
                document.getElementById('loginError').classList.remove('d-none');
            }
        }

        function logout() {
            if(confirm('تأكيد الخروج؟')) location.reload();
        }

        // --- 3. Core UI Functions ---
        function refreshUI() {
            renderList();
            calculateStats();
        }

        function renderList() {
            const container = document.getElementById('inventoryContainer');
            const term = document.getElementById('searchInput').value.toLowerCase();
            
            container.innerHTML = '';
            
            const filtered = db.filter(item => 
                item.name.toLowerCase().includes(term) || 
                (item.active && item.active.toLowerCase().includes(term))
            );

            filtered.forEach((item, index) => {
                // Real Index finding for correct editing
                const realIndex = db.indexOf(item);
                
                // Expiry Calculation
                const daysLeft = Math.ceil((new Date(item.exp) - new Date()) / (1000*60*60*24));
                let statusIcon = '';
                if(daysLeft < 0) statusIcon = '<i class="fas fa-skull text-danger" title="منتهي"></i>';
                else if(daysLeft < 90) statusIcon = '<i class="fas fa-exclamation-triangle text-warning" title="قريب"></i>';

                container.innerHTML += `
                    <div class="item-card" onclick="openEditModal(${realIndex})">
                        <div>
                            <div class="fw-bold text-dark">${item.name} ${statusIcon}</div>
                            <small class="text-muted">ينتهي: ${item.exp}</small>
                        </div>
                        <div class="text-end">
                            <span class="badge-qty">${item.qty}</span>
                            <div class="small fw-bold text-success mt-1">${item.price.toLocaleString()}</div>
                        </div>
                    </div>
                `;
            });
        }

        function calculateStats() {
            // Count
            document.getElementById('statCount').innerText = db.length;
            
            // Value
            const totalVal = db.reduce((a,b) => a + (b.price * b.qty), 0);
            document.getElementById('statValue').innerText = formatMoney(totalVal);
            
            // Expiry (90 days)
            const today = new Date();
            const warningDate = new Date(); warningDate.setDate(today.getDate() + 90);
            const dangerCount = db.filter(i => new Date(i.exp) <= warningDate).length;
            document.getElementById('statExp').innerText = dangerCount;
            
            // Low Stock
            document.getElementById('statLow').innerText = db.filter(i => i.qty < 5).length;
        }

        function formatMoney(num) {
            if(num >= 1000000) return (num/1000000).toFixed(1) + 'M';
            if(num >= 1000) return (num/1000).toFixed(1) + 'K';
            return num;
        }

        // --- 4. CRUD Operations ---
        function openAddModal() {
            document.getElementById('editIndex').value = '';
            document.getElementById('inpName').value = '';
            document.getElementById('inpQty').value = '';
            document.getElementById('inpPrice').value = '';
            document.getElementById('inpExp').value = '';
            document.getElementById('inpActive').value = '';
            document.getElementById('btnDelete').classList.add('d-none');
            new bootstrap.Modal(document.getElementById('itemModal')).show();
        }

        function openEditModal(index) {
            const item = db[index];
            document.getElementById('editIndex').value = index;
            document.getElementById('inpName').value = item.name;
            document.getElementById('inpQty').value = item.qty;
            document.getElementById('inpPrice').value = item.price;
            document.getElementById('inpExp').value = item.exp;
            document.getElementById('inpActive').value = item.active || '';
            document.getElementById('btnDelete').classList.remove('d-none');
            new bootstrap.Modal(document.getElementById('itemModal')).show();
        }

        function saveItem() {
            const idx = document.getElementById('editIndex').value;
            const newItem = {
                name: document.getElementById('inpName').value,
                qty: Number(document.getElementById('inpQty').value),
                price: Number(document.getElementById('inpPrice').value),
                exp: document.getElementById('inpExp').value,
                active: document.getElementById('inpActive').value
            };

            if(!newItem.name || !newItem.price) return alert('أكمل البيانات الأساسية');

            if(idx === '') {
                db.push(newItem);
            } else {
                db[idx] = newItem;
            }
            
            localStorage.setItem('wm_db_v22', JSON.stringify(db));
            bootstrap.Modal.getInstance(document.getElementById('itemModal')).hide();
            refreshUI();
        }

        function deleteItem() {
            const idx = document.getElementById('editIndex').value;
            if(idx !== '' && confirm('حذف الصنف؟')) {
                db.splice(idx, 1);
                localStorage.setItem('wm_db_v22', JSON.stringify(db));
                bootstrap.Modal.getInstance(document.getElementById('itemModal')).hide();
                refreshUI();
            }
        }

        // --- 5. Data & Charts Tools ---
        function openChartModal(type) {
            new bootstrap.Modal(document.getElementById('chartModal')).show();
            const ctx = document.getElementById('theChart').getContext('2d');
            const titleEl = document.getElementById('chartTitle');
            const valEl = document.getElementById('chartMainValue');
            
            if(chartInstance) chartInstance.destroy();

            let config = { type: 'doughnut', data: {}, options: { maintainAspectRatio: false } };

            if(type === 'value') {
                titleEl.innerText = 'توزيع القيمة المالية';
                const total = db.reduce((a,b) => a + (b.price * b.qty), 0);
                valEl.innerText = total.toLocaleString() + ' SDG';
                // Dummy categorization for visualization
                config.data = {
                    labels: ['أدوية غالية', 'أدوية متوسطة', 'أدوية رخيصة'],
                    datasets: [{
                        data: [total*0.5, total*0.3, total*0.2], // Example logic
                        backgroundColor: ['#0f9b0f', '#ffc107', '#0dcaf0']
                    }]
                };
            } else if (type === 'expiry') {
                titleEl.innerText = 'حالة الصلاحية';
                const today = new Date();
                const warnDate = new Date(); warnDate.setDate(today.getDate()+90);
                
                const expired = db.filter(i => new Date(i.exp) < today).length;
                const soon = db.filter(i => new Date(i.exp) >= today && new Date(i.exp) <= warnDate).length;
                const safe = db.length - expired - soon;
                
                valEl.innerText = (expired+soon) + ' صنف في خطر';
                config.data = {
                    labels: ['منتهي', 'قريب', 'سليم'],
                    datasets: [{ data: [expired, soon, safe], backgroundColor: ['#dc3545', '#ffc107', '#198754'] }]
                };
            }
            // Add other cases as needed...

            chartInstance = new Chart(ctx, config);
        }

        function backupData() {
            const dataStr = JSON.stringify(db);
            const blob = new Blob([dataStr], {type: "application/json"});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = "backup_" + new Date().toISOString().slice(0,10) + ".json";
            a.click();
        }

        function restoreData(input) {
            const file = input.files[0];
            if(!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const loaded = JSON.parse(e.target.result);
                    if(confirm('هل تود دمج البيانات (OK) أم استبدالها بالكامل (Cancel)؟')) {
                        db = db.concat(loaded); // Merge
                    } else {
                        db = loaded; // Replace
                    }
                    localStorage.setItem('wm_db_v22', JSON.stringify(db));
                    location.reload();
                } catch(err) { alert('ملف غير صالح'); }
            };
            reader.readAsText(file);
        }

        function exportExcelReport() {
            const ws = XLSX.utils.json_to_sheet(db);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Inventory");
            XLSX.writeFile(wb, "WadAlmansi_Report.xlsx");
        }

        // --- 6. AI OCR ---
        async function handleOCR(input) {
            if(!input.files[0]) return;
            document.getElementById('ocrLoading').classList.remove('d-none');
            try {
                const res = await Tesseract.recognize(input.files[0], 'eng+ara');
                const text = res.data.text;
                // Basic heuristic
                const lines = text.split('\n').filter(l => l.trim().length > 3);
                if(lines.length > 0) document.getElementById('inpName').value = lines[0];
                alert('تم استخراج النص، يرجى المراجعة');
            } catch(e) { alert('فشل التعرف على الصورة'); }
            document.getElementById('ocrLoading').classList.add('d-none');
        }

    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
