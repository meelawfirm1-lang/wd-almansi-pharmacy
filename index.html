<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>إدارة مخزون الصيدلية</title>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.rtl.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>

<style>
body{background:#f4f6f9}
.stat-card{background:#fff;border-radius:16px;padding:15px;cursor:pointer}
</style>
</head>

<body>

<!-- LOGIN -->
<div id="loginSection" class="vh-100 d-flex justify-content-center align-items-center bg-success">
<div class="card p-4 text-center" style="width:300px">
<h4>إدارة مخزون الصيدلية</h4>
<input id="passInput" type="password" class="form-control mb-2" placeholder="الرمز">
<button class="btn btn-success w-100" onclick="attemptLogin()">دخول</button>
<p id="loginError" class="text-danger d-none">خطأ</p>
</div>
</div>

<!-- DASHBOARD -->
<div id="mainDashboard" class="d-none">

<div class="container mt-3">

<div class="row g-2">
<div class="col-6">
<div class="stat-card border border-success" onclick="showItemsReport()">
<h6>الأصناف</h6>
<h3 id="statCount">0</h3>
</div>
</div>

<div class="col-6">
<div class="stat-card border border-primary" onclick="showValueReport()">
<h6>القيمة</h6>
<h3 id="statValue">0</h3>
</div>
</div>

<div class="col-6">
<div class="stat-card border border-danger" onclick="showExpiryReport()">
<h6>سينتهي قريباً</h6>
<h3 id="statExp">0</h3>
</div>
</div>

<div class="col-6">
<div class="stat-card border border-warning" onclick="showLowStock()">
<h6>النواقص</h6>
<h3 id="statLow">0</h3>
</div>
</div>
</div>

<hr>

<button class="btn btn-success w-100" onclick="openAddModal()">إضافة صنف</button>

<div id="inventoryContainer" class="mt-3"></div>

</div>
</div>

<!-- ADD / EDIT -->
<div class="modal fade" id="itemModal">
<div class="modal-dialog">
<div class="modal-content p-3">
<input type="hidden" id="editIndex">

<input id="inpName" class="form-control mb-2" placeholder="اسم الدواء">
<input id="inpQty" type="number" class="form-control mb-2" placeholder="الكمية">
<input id="inpBuy" type="number" class="form-control mb-2" placeholder="سعر الشراء">

<label>نسبة الزيادة</label>
<input type="range" min="1" max="100" value="20" class="form-range" id="profitRange">
<small id="profitLabel">20%</small>

<input id="inpPrice" type="number" class="form-control mb-2" placeholder="سعر البيع">
<input id="inpExp" type="date" class="form-control mb-2">

<button class="btn btn-success w-100" onclick="saveItem()">حفظ</button>
<button class="btn btn-danger w-100 mt-1 d-none" id="btnDelete" onclick="deleteItem()">حذف</button>
</div>
</div>
</div>

<!-- REPORT -->
<div class="modal fade" id="reportModal">
<div class="modal-dialog modal-lg modal-dialog-scrollable">
<div class="modal-content">
<div class="modal-header">
<h5 id="reportTitle"></h5>
<button class="btn-close" data-bs-dismiss="modal"></button>
</div>
<div class="modal-body" id="reportBody"></div>
</div>
</div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
/* ===== DATA ===== */
const SYS_PASS="123456";
let db=JSON.parse(localStorage.getItem("db"))||[];
let usdRate=Number(localStorage.getItem("usd"))||1000;

/* ===== LOGIN ===== */
function attemptLogin(){
if(passInput.value===SYS_PASS){
loginSection.classList.add("d-none");
mainDashboard.classList.remove("d-none");
refresh();
}else loginError.classList.remove("d-none");
}

/* ===== UI ===== */
function refresh(){
inventoryContainer.innerHTML="";
db.forEach((i,idx)=>{
inventoryContainer.innerHTML+=`
<div class="card p-2 mb-1" onclick="openEdit(${idx})">
<strong>${i.name}</strong>
<span>كمية: ${i.qty}</span>
</div>`;
});
statCount.innerText=db.length;
statValue.innerText=db.reduce((a,b)=>a+b.price*b.qty,0);
statLow.innerText=db.filter(i=>i.qty<5).length;
statExp.innerText=db.filter(i=>daysLeft(i.exp)<=90).length;
}

/* ===== HELPERS ===== */
function daysLeft(d){return Math.ceil((new Date(d)-new Date())/86400000);}

/* ===== CRUD ===== */
function openAddModal(){
editIndex.value="";
itemModal.show();
}

function openEdit(i){
editIndex.value=i;
let x=db[i];
inpName.value=x.name;
inpQty.value=x.qty;
inpBuy.value=x.buy;
inpPrice.value=x.price;
inpExp.value=x.exp;
btnDelete.classList.remove("d-none");
itemModal.show();
}

function saveItem(){
let item={
name:inpName.value,
qty:+inpQty.value,
buy:+inpBuy.value,
price:+inpPrice.value,
exp:inpExp.value
};
if(editIndex.value==="") db.push(item);
else db[editIndex.value]=item;
localStorage.setItem("db",JSON.stringify(db));
itemModal.hide();
refresh();
}

function deleteItem(){
db.splice(editIndex.value,1);
localStorage.setItem("db",JSON.stringify(db));
itemModal.hide();
refresh();
}

/* ===== REPORTS ===== */
function showItemsReport(){
reportTitle.innerText="تقرير الأصناف";
reportBody.innerHTML="<ol>"+db.map(i=>`<li>${i.name}</li>`).join("")+"</ol><hr>الإجمالي: "+db.length;
reportModal.show();
}

function showValueReport(){
let total=db.reduce((a,b)=>a+b.price*b.qty,0);
reportTitle.innerText="تقرير القيمة";
reportBody.innerHTML=`
القيمة بالجنيه: ${total}<br>
القيمة بالدولار: ${(total/usdRate).toFixed(2)}
<hr>
<input type="number" value="${usdRate}" onchange="usdRate=this.value;localStorage.setItem('usd',this.value)">
`;
reportModal.show();
}

function showExpiryReport(){
reportTitle.innerText="قريب الانتهاء";
reportBody.innerHTML=db.filter(i=>daysLeft(i.exp)<=90)
.map(i=>`${i.name} – ${daysLeft(i.exp)} يوم`).join("<br>");
reportModal.show();
}

function showLowStock(){
reportTitle.innerText="النواقص";
reportBody.innerHTML=db.filter(i=>i.qty<5)
.map(i=>`${i.name} – ${i.qty}`).join("<br>");
reportModal.show();
}

/* ===== PROFIT ===== */
profitRange.oninput=()=>{
profitLabel.innerText=profitRange.value+"%";
inpPrice.value=Math.round(inpBuy.value*(1+profitRange.value/100));
}
</script>

</body>
</html>
