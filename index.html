<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>صيدلية ود المنسي - موبايل</title>
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.rtl.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>

    <style>
        :root {
            --primary-color: #198754;
            --bg-color: #f8f9fa;
            --card-bg: #ffffff;
            --text-color: #212529;
        }

        [data-bs-theme="dark"] {
            --primary-color: #2ecc71;
            --bg-color: #121212;
            --card-bg: #1e1e1e;
            --text-color: #e0e0e0;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            padding-bottom: 80px; /* مساحة للتمرير في الموبايل */
        }

        /* --- Header Styles --- */
        .mobile-header {
            background: linear-gradient(135deg, #198754, #0f5132);
            color: white;
            padding: 15px;
            border-radius: 0 0 20px 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.15);
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .header-controls .btn {
            border-radius: 50px;
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            transition: transform 0.2s;
            margin-left: 5px;
        }
        .header-controls .btn:active { transform: scale(0.95); }

        /* زر الإضافة الكبير في الأعلى */
        .btn-add-main {
            background-color: #ffc107 !important;
            color: #000 !important;
            font-weight: bold;
            box-shadow: 0 4px 10px rgba(255, 193, 7, 0.4);
        }

        /* --- Grid Cards (Mobile Optimized) --- */
        .stat-card {
            background: var(--card-bg);
            border-radius: 15px;
            padding: 15px;
            height: 100%;
            border: none;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            transition: transform 0.2s;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }
        
        .stat-card:active { transform: scale(0.98); background-color: rgba(0,0,0,0.02); }
        
        /* شريط ملون جانبي للبطاقة */
        .border-left-success { border-left: 5px solid #198754; }
        .border-left-primary { border-left: 5px solid #0d6efd; }
        .border-left-danger { border-left: 5px solid #dc3545; }
        .border-left-warning { border-left: 5px solid #ffc107; }

        .stat-icon {
            position: absolute;
            top: 10px;
            left: 10px;
            opacity: 0.1;
            font-size: 2.5rem;
        }

        .stat-value { font-size: 1.4rem; font-weight: bold; margin: 5px 0; }
        .stat-label { font-size: 0.8rem; color: #6c757d; }

        /* --- Inventory List --- */
        .inventory-item {
            background: var(--card-bg);
            margin-bottom: 10px;
            border-radius: 12px;
            padding: 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .item-details h6 { margin: 0; font-weight: bold; font-size: 0.95rem; }
        .item-details small { font-size: 0.75rem; color: #888; }
        
        .badge-qty {
            font-size: 0.9rem;
            padding: 5px 10px;
            border-radius: 8px;
            background-color: #e9ecef;
            color: #333;
        }

        /* --- AI Camera Button --- */
        .camera-btn-wrapper {
            position: relative;
            overflow: hidden;
            display: inline-block;
        }
        .camera-input {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            opacity: 0; cursor: pointer;
        }

        /* --- Responsive Tweaks --- */
        @media (max-width: 576px) {
            .stat-value { font-size: 1.2rem; }
            .mobile-header { padding: 10px; }
            h4 { font-size: 1.2rem; }
        }
    </style>
</head>
<body>

    <div id="loginSection" class="container d-flex flex-column justify-content-center align-items-center vh-100">
        <div class="card p-4 shadow-lg border-0 rounded-4 text-center" style="width: 100%; max-width: 350px;">
            <div class="mb-3 text-success"><i class="fas fa-fingerprint fa-3x"></i></div>
            <h4 class="mb-4">ود المنسي</h4>
            <input type="password" id="passwordInput" class="form-control mb-3 text-center rounded-pill" placeholder="كلمة المرور">
            <button onclick="checkLogin()" class="btn btn-success w-100 rounded-pill">دخول</button>
            <p id="loginError" class="text-danger mt-2 small" style="display:none;">خطأ في كلمة المرور</p>
        </div>
    </div>

    <div id="mainDashboard" style="display:none;">
        
        <div class="mobile-header d-flex justify-content-between align-items-center">
            <div class="d-flex align-items-center">
                <i class="fas fa-clinic-medical me-2"></i>
                <span class="fw-bold">لوحة التحكم</span>
            </div>
            
            <div class="header-controls d-flex">
                <button onclick="openAddModal()" class="btn btn-add-main">
                    <i class="fas fa-plus"></i> <span class="d-none d-sm-inline">إضافة دواء</span>
                </button>
                
                <button onclick="showFullInventoryReport()" class="btn"><i class="fas fa-file-alt"></i></button>
                <button onclick="toggleTheme()" class="btn"><i class="fas fa-moon" id="themeIcon"></i></button>
                <button onclick="confirmLogout()" class="btn bg-danger text-white"><i class="fas fa-power-off"></i></button>
            </div>
        </div>

        <div class="container-fluid px-3 py-3">
            
            <div class="row g-2 mb-3">
                <div class="col-6">
                    <div class="stat-card border-left-success" onclick="showChartModal('items')">
                        <i class="fas fa-boxes stat-icon text-success"></i>
                        <div class="stat-value" id="totalItems">0</div>
                        <div class="stat-label">إجمالي الأصناف</div>
                    </div>
                </div>
                <div class="col-6">
                    <div class="stat-card border-left-primary" onclick="showChartModal('value')">
                        <i class="fas fa-dollar-sign stat-icon text-primary"></i>
                        <div class="stat-value" id="totalValueSmall">0</div>
                        <div class="stat-label">القيمة (اضغط للتفاصيل)</div>
                    </div>
                </div>
                <div class="col-6">
                    <div class="stat-card border-left-danger" onclick="showChartModal('expiry')">
                        <i class="fas fa-hourglass-end stat-icon text-danger"></i>
                        <div class="stat-value text-danger" id="expiredAlerts">0</div>
                        <div class="stat-label">ينتهي قريباً (3 شهور)</div>
                    </div>
                </div>
                <div class="col-6">
                    <div class="stat-card border-left-warning" onclick="showChartModal('stock')">
                        <i class="fas fa-battery-quarter stat-icon text-warning"></i>
                        <div class="stat-value text-warning" id="lowStock">0</div>
                        <div class="stat-label">النواقص (أقل من 5)</div>
                    </div>
                </div>
            </div>

            <div class="input-group mb-3 shadow-sm rounded-pill overflow-hidden bg-white">
                <span class="input-group-text border-0 bg-white ps-3"><i class="fas fa-search text-muted"></i></span>
                <input type="text" id="searchInput" onkeyup="searchItems()" class="form-control border-0" placeholder="ابحث عن دواء أو مادة فعالة...">
            </div>

            <h6 class="text-muted mb-2 px-1">قائمة الأدوية</h6>
            <div id="inventoryList">
                </div>

        </div>
    </div>

    <div class="modal fade" id="addItemModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content rounded-4 border-0">
                <div class="modal-header border-0 pb-0">
                    <h5 class="modal-title fw-bold">إضافة/تعديل دواء</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="d-grid mb-3">
                        <div class="camera-btn-wrapper btn btn-outline-primary py-3 rounded-3 dashed-border">
                            <i class="fas fa-camera fa-lg mb-1"></i><br>
                            <strong>التقاط صورة للعلبة (AI)</strong>
                            <input type="file" id="cameraInput" accept="image/*" capture="environment" class="camera-input" onchange="processImageAI(this)">
                        </div>
                        <div id="aiLoading" class="text-center mt-2 text-primary small" style="display:none;">
                            <span class="spinner-border spinner-border-sm"></span> جاري قراءة البيانات...
                        </div>
                    </div>

                    <input type="hidden" id="editIndex">
                    <div class="row g-2">
                        <div class="col-12">
                            <label class="small text-muted">اسم الدواء</label>
                            <input type="text" id="itemName" class="form-control bg-light">
                        </div>
                        <div class="col-6">
                            <label class="small text-muted">الكمية</label>
                            <input type="number" id="itemQty" class="form-control bg-light">
                        </div>
                        <div class="col-6">
                            <label class="small text-muted">السعر</label>
                            <input type="number" id="itemPrice" class="form-control bg-light">
                        </div>
                        <div class="col-12">
                            <label class="small text-muted">تاريخ الانتهاء</label>
                            <input type="date" id="itemExp" class="form-control bg-light">
                        </div>
                        <div class="col-12">
                            <label class="small text-muted">التصنيف</label>
                            <select id="itemCategory" class="form-select bg-light">
                                <option value="مسكنات">مسكنات</option>
                                <option value="مضادات حيوية">مضادات حيوية</option>
                                <option value="أخرى">أخرى</option>
                            </select>
                        </div>
                        <div class="col-12">
                            <label class="small text-muted">المادة الفعالة</label>
                            <input type="text" id="itemActive" class="form-control bg-light">
                        </div>
                    </div>
                </div>
                <div class="modal-footer border-0 pt-0">
                    <button onclick="saveItem()" class="btn btn-success w-100 rounded-pill py-2">حفظ</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="chartModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content rounded-4">
                <div class="modal-header border-0">
                    <h5 class="modal-title fw-bold" id="chartModalTitle">تحليل البيانات</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body text-center">
                    <h3 id="chartModalValue" class="mb-3 fw-bold text-primary"></h3>
                    <div style="height: 250px; position: relative;">
                        <canvas id="genericChart"></canvas>
                    </div>
                    <p id="chartModalDesc" class="mt-3 text-muted small"></p>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="reportModal" tabindex="-1">
        <div class="modal-dialog modal-fullscreen">
            <div class="modal-content">
                <div class="modal-header bg-dark text-white">
                    <h5 class="modal-title">التقرير الشامل</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-0">
                    <div class="p-2 d-flex justify-content-end bg-light border-bottom">
                         <button onclick="exportToExcel()" class="btn btn-sm btn-success"><i class="fas fa-file-excel"></i> Excel</button>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-striped table-sm mb-0" id="reportTable">
                            <thead class="table-dark sticky-top">
                                <tr>
                                    <th>#</th>
                                    <th>الدواء</th>
                                    <th>الكمية</th>
                                    <th>السعر</th>
                                    <th>الانتهاء</th>
                                </tr>
                            </thead>
                            <tbody id="reportTableBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- Data & Config ---
        const ADMIN_PASS = "123456";
        let inventory = JSON.parse(localStorage.getItem('wm_inventory_v2')) || [];
        let currentChart = null;
        let exchangeRate = 3000;

        // --- Auth ---
        function checkLogin() {
            if(document.getElementById('passwordInput').value === ADMIN_PASS) {
                document.getElementById('loginSection').style.display = 'none';
                document.getElementById('mainDashboard').style.display = 'block';
                renderInventory();
                updateStats();
            } else {
                document.getElementById('loginError').style.display = 'block';
            }
        }

        function confirmLogout() {
            if(confirm("هل تريد الخروج؟")) location.reload();
        }

        // --- Core Logic ---
        function renderInventory(filter = "") {
            const list = document.getElementById('inventoryList');
            list.innerHTML = "";
            
            const filtered = inventory.filter(i => 
                i.name.toLowerCase().includes(filter.toLowerCase()) || 
                (i.active && i.active.toLowerCase().includes(filter.toLowerCase()))
            );

            filtered.forEach((item, index) => {
                // Expiry Logic
                const today = new Date();
                const expDate = new Date(item.exp);
                const diffTime = expDate - today;
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                
                let expColor = "text-muted";
                if(diffDays < 0) expColor = "text-danger fw-bold"; // Expired
                else if(diffDays <= 90) expColor = "text-warning fw-bold"; // Warning (3 months)

                list.innerHTML += `
                    <div class="inventory-item" onclick="editItem(${index})">
                        <div class="item-details">
                            <h6>${item.name}</h6>
                            <small class="${expColor}"><i class="fas fa-calendar-alt"></i> ${item.exp}</small> | 
                            <small>${item.price.toLocaleString()} ج.س</small>
                        </div>
                        <div class="d-flex align-items-center">
                            <span class="badge-qty ms-2">${item.qty}</span>
                            <i class="fas fa-chevron-left text-muted ms-2" style="font-size: 0.8rem;"></i>
                        </div>
                    </div>
                `;
            });
        }

        function updateStats() {
            // Totals
            document.getElementById('totalItems').innerText = inventory.length;
            
            let totalVal = inventory.reduce((acc, curr) => acc + (curr.price * curr.qty), 0);
            
            // Format Large Numbers (K, M) for mobile space
            let displayVal = totalVal >= 1000000 ? (totalVal/1000000).toFixed(1) + 'M' : 
                             totalVal >= 1000 ? (totalVal/1000).toFixed(1) + 'K' : totalVal;
            
            document.getElementById('totalValueSmall').innerText = displayVal;

            // Expiry (3 Months = 90 days)
            const today = new Date();
            const limit = new Date();
            limit.setDate(today.getDate() + 90);
            
            const expiring = inventory.filter(i => {
                const d = new Date(i.exp);
                return d <= limit;
            }).length;
            document.getElementById('expiredAlerts').innerText = expiring;

            // Low Stock
            const low = inventory.filter(i => i.qty < 5).length;
            document.getElementById('lowStock').innerText = low;
        }

        function searchItems() {
            renderInventory(document.getElementById('searchInput').value);
        }

        // --- Modals & CRUD ---
        function openAddModal() {
            document.getElementById('editIndex').value = "";
            document.getElementById('itemName').value = "";
            document.getElementById('itemQty').value = "";
            document.getElementById('itemPrice').value = "";
            document.getElementById('itemExp').value = "";
            document.getElementById('itemActive').value = "";
            new bootstrap.Modal(document.getElementById('addItemModal')).show();
        }

        function editItem(originalIndex) {
            // Find actual index in main array (in case of filter)
            // Simplified here assuming render passes direct index or we handle ID.
            // For now, we reload filtering. In production, use unique IDs.
            const item = inventory[originalIndex];
            document.getElementById('editIndex').value = originalIndex;
            document.getElementById('itemName').value = item.name;
            document.getElementById('itemQty').value = item.qty;
            document.getElementById('itemPrice').value = item.price;
            document.getElementById('itemExp').value = item.exp;
            document.getElementById('itemActive').value = item.active || "";
            document.getElementById('itemCategory').value = item.category || "أخرى";
            new bootstrap.Modal(document.getElementById('addItemModal')).show();
        }

        function saveItem() {
            const idx = document.getElementById('editIndex').value;
            const item = {
                name: document.getElementById('itemName').value,
                qty: Number(document.getElementById('itemQty').value),
                price: Number(document.getElementById('itemPrice').value),
                exp: document.getElementById('itemExp').value,
                active: document.getElementById('itemActive').value,
                category: document.getElementById('itemCategory').value
            };

            if(!item.name || !item.price) return alert("يرجى إدخال البيانات الأساسية");

            if(idx === "") {
                inventory.push(item);
            } else {
                if(confirm("هل تريد حفظ التعديلات؟ (اضغط إلغاء للحذف)")) {
                    inventory[idx] = item;
                } else {
                    if(confirm("هل أنت متأكد من الحذف؟")) inventory.splice(idx, 1);
                }
            }

            localStorage.setItem('wm_inventory_v2', JSON.stringify(inventory));
            bootstrap.Modal.getInstance(document.getElementById('addItemModal')).hide();
            renderInventory();
            updateStats();
        }

        // --- AI Camera Logic ---
        async function processImageAI(input) {
            if(!input.files[0]) return;
            
            document.getElementById('aiLoading').style.display = 'block';
            
            try {
                const result = await Tesseract.recognize(
                    input.files[0],
                    'eng+ara',
                    { logger: m => console.log(m) }
                );
                
                const text = result.data.text;
                // Simple parsing heuristics
                const lines = text.split('\n').filter(l => l.length > 3);
                if(lines.length > 0) document.getElementById('itemName').value = lines[0]; // Guess name
                
                // Try to find numbers for price/qty
                // This is basic; in real app needs regex
                
                alert("تم استخراج البيانات! يرجى المراجعة.");
            } catch (e) {
                alert("تعذر قراءة الصورة");
            } finally {
                document.getElementById('aiLoading').style.display = 'none';
            }
        }

        // --- Charts Modal Logic ---
        function showChartModal(type) {
            const modalTitle = document.getElementById('chartModalTitle');
            const modalVal = document.getElementById('chartModalValue');
            const modalDesc = document.getElementById('chartModalDesc');
            const ctx = document.getElementById('genericChart').getContext('2d');

            if(currentChart) currentChart.destroy();

            new bootstrap.Modal(document.getElementById('chartModal')).show();

            let data, labels, colors, title;

            if(type === 'value') {
                title = "توزيع القيمة المالية";
                const totalSDG = inventory.reduce((a, b) => a + (b.price * b.qty), 0);
                const totalUSD = totalSDG / exchangeRate;
                
                modalVal.innerText = `${totalSDG.toLocaleString()} SDG`;
                modalDesc.innerText = `ما يعادل تقريباً ${totalUSD.toFixed(2)} دولار`;

                // Chart: Categories Value
                const cats = {};
                inventory.forEach(i => cats[i.category] = (cats[i.category]||0) + (i.price*i.qty));
                
                currentChart = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: Object.keys(cats),
                        datasets: [{
                            data: Object.values(cats),
                            backgroundColor: ['#198754', '#0d6efd', '#ffc107', '#dc3545']
                        }]
                    }
                });

            } else if (type === 'expiry') {
                title = "حالة الصلاحية";
                const today = new Date();
                const limit = new Date(); limit.setDate(today.getDate() + 90);
                
                const expired = inventory.filter(i => new Date(i.exp) < today).length;
                const soon = inventory.filter(i => new Date(i.exp) >= today && new Date(i.exp) <= limit).length;
                const safe = inventory.length - expired - soon;

                modalVal.innerText = `${expired + soon} صنف خطر`;
                modalDesc.innerText = "أصناف منتهية أو ستنتهي خلال 3 شهور";

                currentChart = new Chart(ctx, {
                    type: 'pie',
                    data: {
                        labels: ['منتهي', 'قريب الانتهاء', 'آمن'],
                        datasets: [{
                            data: [expired, soon, safe],
                            backgroundColor: ['#dc3545', '#ffc107', '#198754']
                        }]
                    }
                });
            } else {
                 // Fallback or other types like Stock
                 modalTitle.innerText = "تفاصيل";
            }
            
            if(title) modalTitle.innerText = title;
        }

        // --- Reports ---
        function showFullInventoryReport() {
            const tbody = document.getElementById('reportTableBody');
            tbody.innerHTML = "";
            inventory.forEach((item, i) => {
                tbody.innerHTML += `
                    <tr>
                        <td>${i+1}</td>
                        <td>${item.name}</td>
                        <td>${item.qty}</td>
                        <td>${item.price}</td>
                        <td>${item.exp}</td>
                    </tr>
                `;
            });
            new bootstrap.Modal(document.getElementById('reportModal')).show();
        }

        function exportToExcel() {
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.json_to_sheet(inventory);
            XLSX.utils.book_append_sheet(wb, ws, "Inventory");
            XLSX.writeFile(wb, "WadAlmansi_Report.xlsx");
        }

        function toggleTheme() {
            const h = document.documentElement;
            if(h.getAttribute('data-bs-theme') === 'dark') {
                h.setAttribute('data-bs-theme', 'light');
            } else {
                h.setAttribute('data-bs-theme', 'dark');
            }
        }
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
