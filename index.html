<!DOCTYPE html>
<html lang="en" dir="ltr" id="htmlTag">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Pharmacy Inventory Management</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#0f9b0f">
    
    <link rel="apple-touch-icon" href="icons/icon-192x192.png">

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" id="bootstrapLib">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>

    <style>
        :root {
            --primary-color: #0f9b0f;
            --bg-light: #f4f6f9;
            --card-radius: 16px;
            --text-main: #333;
            --card-bg: #ffffff;
        }

        [data-theme="dark"] {
            --bg-light: #121212;
            --text-main: #e0e0e0;
            --card-bg: #1e1e1e;
        }

        body {
            background-color: var(--bg-light);
            color: var(--text-main);
            font-family: 'Segoe UI', Tahoma, sans-serif;
            transition: 0.3s;
            overflow-x: hidden;
        }

        .card, .stat-card, .item-card, .mobile-header, .modal-content, #exchangeRateContainer {
            background-color: var(--card-bg) !important;
            color: var(--text-main) !important;
        }

        #loginSection {
            position: fixed; top: 0; left: 0; width: 100%; height: 100vh;
            background: linear-gradient(135deg, #0f9b0f, #004d00);
            z-index: 9999; display: flex; flex-direction: column; justify-content: center; align-items: center;
        }

        .mobile-header {
            padding: 10px 15px; border-radius: 0 0 20px 20px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.05);
            position: sticky; top: 0; z-index: 1000;
            display: flex; justify-content: space-between; align-items: center;
        }

        .btn-tool {
            width: 38px; height: 38px; border-radius: 50%; border: none;
            background: rgba(0,0,0,0.05); color: var(--text-main);
            display: flex; align-items: center; justify-content: center;
        }

        .btn-main-add {
            background: var(--primary-color); color: white;
            padding: 8px 18px; border-radius: 30px; font-weight: bold; border: none;
        }

        .stat-card {
            border-radius: var(--card-radius); padding: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.03); border-bottom: 4px solid transparent;
        }

        .item-card {
            border-radius: 12px; margin-bottom: 10px; padding: 12px;
            display: flex; justify-content: space-between; align-items: center;
            border: 1px solid rgba(0,0,0,0.05);
        }

        .d-none-custom { display: none !important; }
    </style>
</head>
<body>

    <div id="loginSection">
        <div class="card p-4 text-center rounded-4 shadow" style="width: 90%; max-width: 320px;">
            <div class="mb-3 text-success"><i class="fas fa-mortar-pestle fa-3x"></i></div>
            <h4 class="fw-bold mb-1" data-tr="app_title">Pharmacy Management</h4>
            <small class="text-muted mb-4" data-tr="app_sub">Wad Almansi System</small>
            <input type="password" id="passInput" class="form-control text-center rounded-pill mb-3" placeholder="PIN">
            <button onclick="attemptLogin()" class="btn btn-success w-100 rounded-pill fw-bold" data-tr="login_btn">Login</button>
            <p id="loginError" class="text-danger mt-2 small d-none" data-tr="login_error">Incorrect PIN</p>
        </div>
    </div>

    <div id="mainDashboard" class="d-none-custom">
        <div class="mobile-header">
            <div class="d-flex gap-2">
                <div class="dropdown">
                    <button class="btn-tool" data-bs-toggle="dropdown"><i class="fas fa-cog"></i></button>
                    <ul class="dropdown-menu shadow border-0">
                        <li><a class="dropdown-item" href="#" onclick="backupData()"><i class="fas fa-download text-success"></i> <span data-tr="backup">Backup</span></a></li>
                        <li><a class="dropdown-item" href="#" onclick="document.getElementById('restoreFile').click()"><i class="fas fa-upload text-primary"></i> <span data-tr="restore">Restore</span></a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item" href="#" onclick="document.getElementById('importExcelFile').click()"><i class="fas fa-file-excel text-success"></i> <span data-tr="import">Import Excel</span></a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item text-danger" href="#" onclick="logout()"><i class="fas fa-sign-out-alt"></i> <span data-tr="logout">Logout</span></a></li>
                    </ul>
                </div>
                <button class="btn-tool" onclick="toggleLanguage()"><i class="fas fa-language"></i></button>
                <button class="btn-tool" onclick="toggleDarkMode()"><i class="fas fa-moon" id="themeIcon"></i></button>
            </div>
            <h6 class="m-0 fw-bold text-success" data-tr="header_title">Inventory</h6>
            <button onclick="openAddModal()" class="btn-main-add"><i class="fas fa-plus"></i> <span data-tr="add_btn">Add</span></button>
        </div>

        <div class="container-fluid p-3">
            <div id="exchangeRateContainer" class="d-flex align-items-center justify-content-between mb-3 p-2 rounded-3 border">
                <label class="small fw-bold m-0"><i class="fas fa-dollar-sign text-success"></i> <span data-tr="usd_rate">USD Rate:</span></label>
                <input type="number" id="exchangeRateInput" onchange="updateExchangeRate(this.value)" class="form-control form-control-sm text-center" style="width: 100px;">
            </div>

            <div class="row g-2 mb-3">
                <div class="col-6"><div class="stat-card border-success"><h6 class="small mb-1" data-tr="stat_items">Items</h6><h4 class="fw-bold m-0" id="statCount">0</h4></div></div>
                <div class="col-6"><div class="stat-card border-primary"><h6 class="small mb-1" data-tr="stat_value">Value</h6><h5 class="fw-bold m-0" id="statValue">0</h5></div></div>
            </div>

            <input type="text" id="searchInput" onkeyup="renderList()" class="form-control rounded-pill mb-3" data-placeholder-tr="search_placeholder" placeholder="Search...">
            <div id="inventoryContainer"></div>
        </div>
    </div>

    <input type="file" id="restoreFile" style="display:none" onchange="handleRestoreFile(this)" accept=".json">
    <input type="file" id="importExcelFile" style="display:none" onchange="handleImportExcelFile(this)" accept=".xlsx, .xls">

    <script>
        // إعدادات PWA - تسجيل الـ Service Worker
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('service-worker.js').then(() => console.log("PWA Ready"));
        }

        const translations = {
            en: {
                app_title: "Pharmacy Management", app_sub: "Wad Almansi System",
                login_btn: "Login", login_error: "Incorrect PIN",
                header_title: "Inventory", add_btn: "Add",
                backup: "Backup", restore: "Restore", import: "Import Excel", logout: "Logout",
                usd_rate: "USD Rate (SDG):", search_placeholder: "Search items...",
                stat_items: "Total Items", stat_value: "Total Value"
            },
            ar: {
                app_title: "إدارة الصيدلية", app_sub: "نظام ود المنسي",
                login_btn: "دخول", login_error: "الرمز غير صحيح",
                header_title: "المخزون", add_btn: "إضافة",
                backup: "نسخة احتياطية", restore: "استعادة", import: "استيراد إكسل", logout: "خروج",
                usd_rate: "سعر الدولار (SDG):", search_placeholder: "بحث عن صنف...",
                stat_items: "إجمالي الأصناف", stat_value: "القيمة الإجمالية"
            }
        };

        let currentLang = localStorage.getItem('app_lang') || 'en';
        let db = JSON.parse(localStorage.getItem('wm_db_v23')) || [];

        function updateLanguageUI() {
            document.querySelectorAll('[data-tr]').forEach(el => el.innerText = translations[currentLang][el.getAttribute('data-tr')]);
            document.querySelectorAll('[data-placeholder-tr]').forEach(el => el.placeholder = translations[currentLang][el.getAttribute('data-placeholder-tr')]);
            document.getElementById('htmlTag').dir = currentLang === 'ar' ? 'rtl' : 'ltr';
            document.getElementById('bootstrapLib').href = currentLang === 'ar' ? 
                "https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.rtl.min.css" : 
                "https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css";
        }

        function toggleLanguage() {
            currentLang = currentLang === 'en' ? 'ar' : 'en';
            localStorage.setItem('app_lang', currentLang);
            updateLanguageUI();
        }

        function toggleDarkMode() {
            const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
            document.documentElement.setAttribute('data-theme', isDark ? 'light' : 'dark');
            localStorage.setItem('app_theme', isDark ? 'light' : 'dark');
            document.getElementById('themeIcon').className = isDark ? 'fas fa-moon' : 'fas fa-sun';
        }

        function attemptLogin() {
            if(document.getElementById('passInput').value === "123456") {
                document.getElementById('loginSection').classList.add('d-none-custom');
                document.getElementById('mainDashboard').classList.remove('d-none-custom');
                refreshUI();
            } else { document.getElementById('loginError').classList.remove('d-none'); }
        }

        function refreshUI() {
            renderList();
            document.getElementById('statCount').innerText = db.length;
            const total = db.reduce((a,b) => a + (b.price * b.qty), 0);
            document.getElementById('statValue').innerText = total.toLocaleString() + " SDG";
        }

        function renderList() {
            const term = document.getElementById('searchInput').value.toLowerCase();
            const container = document.getElementById('inventoryContainer');
            container.innerHTML = '';
            db.filter(i => i.name.toLowerCase().includes(term)).forEach(item => {
                container.innerHTML += `<div class="item-card shadow-sm">
                    <div><div class="fw-bold">${item.name}</div><small class="text-muted">${item.exp}</small></div>
                    <div class="fw-bold text-success">${(item.price * item.qty).toLocaleString()}</div>
                </div>`;
            });
        }

        // استدعاء التهيئة عند التحميل
        document.addEventListener('DOMContentLoaded', () => {
            updateLanguageUI();
            if(localStorage.getItem('app_theme') === 'dark') toggleDarkMode();
        });

        function logout() { location.reload(); }
        function backupData() {
            const blob = new Blob([JSON.stringify(db)], {type: "application/json"});
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = "backup.json";
            a.click();
        }
    </script>
</body>
</html>
