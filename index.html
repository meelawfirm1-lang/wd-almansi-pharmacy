<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>إدارة مخزون الصيدلية - ماسح الفواتير الذكي</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#0f9b0f">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/883/883407.png">
  
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.rtl.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>

<style>
    :root {
        --primary-color: #0f9b0f;
        --bg-light: #f4f6f9;
        --card-radius: 16px;
    }

    body {
        background-color: var(--bg-light);
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        overflow-x: hidden;
    }

    /* --- Login Screen Styling --- */
    #loginSection {
        position: fixed;
        top: 0; left: 0; width: 100%; height: 100vh;
        background: linear-gradient(135deg, #0f9b0f, #004d00);
        z-index: 9999;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
    }

    /* --- Header & Navigation --- */
    .mobile-header {
        background: white;
        padding: 10px 15px;
        border-radius: 0 0 20px 20px;
        box-shadow: 0 5px 20px rgba(0,0,0,0.05);
        position: sticky;
        top: 0;
        z-index: 1000;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .header-buttons {
        display: flex;
        gap: 10px;
        align-items: center;
    }

    .btn-tool {
        width: 40px; height: 40px;
        border-radius: 50%;
        border: none;
        background: #f8f9fa;
        color: #333;
        display: flex; align-items: center; justify-content: center;
        transition: 0.2s;
    }
    .btn-tool:active { transform: scale(0.9); background: #e2e6ea; }

    .btn-main {
        padding: 8px 20px;
        border-radius: 30px;
        font-weight: bold;
        border: none;
        display: flex;
        align-items: center;
        gap: 8px;
        transition: all 0.3s;
    }

    .btn-main-add {
        background: var(--primary-color);
        color: white;
        box-shadow: 0 4px 10px rgba(15, 155, 15, 0.3);
    }

    .btn-main-invoice {
        background: linear-gradient(135deg, #6c5ce7, #0984e3);
        color: white;
        box-shadow: 0 4px 10px rgba(108, 92, 231, 0.3);
    }

    /* --- Stats Grid --- */
    .stat-card {
        background: white;
        border-radius: var(--card-radius);
        padding: 15px;
        height: 100%;
        box-shadow: 0 2px 10px rgba(0,0,0,0.03);
        border-bottom: 4px solid transparent;
        transition: transform 0.2s;
        cursor: pointer;
    }
    .stat-card:active { transform: scale(0.98); }
    
    .border-success { border-bottom-color: #198754 !important; }
    .border-primary { border-bottom-color: #0d6efd !important; }
    .border-danger  { border-bottom-color: #dc3545 !important; }
    .border-warning { border-bottom-color: #ffc107 !important; }

    /* --- Inventory List --- */
    .item-card {
        background: white;
        border-radius: 12px;
        margin-bottom: 10px;
        padding: 12px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        box-shadow: 0 2px 5px rgba(0,0,0,0.02);
    }
    .badge-qty {
        background: #e9ecef; color: #333;
        padding: 4px 8px; border-radius: 6px; font-weight: bold; font-size: 0.85rem;
    }

    /* --- AI Camera --- */
    .camera-trigger {
        border: 2px dashed #0d6efd;
        background: #f8f9fa;
        color: #0d6efd;
        padding: 20px;
        text-align: center;
        border-radius: 12px;
        position: relative;
        cursor: pointer;
    }
    .camera-input {
        position: absolute; top:0; left:0; width:100%; height:100%; opacity:0;
    }

    /* Helper Utility to hide/show */
    .d-none-custom { display: none !important; }
    
    /* New Styles for Exchange Rate and Profit */
    #exchangeRateContainer {
        background: white;
        padding: 10px;
        border-radius: 10px;
        margin-bottom: 10px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.05);
    }
    
    .profit-calculator {
        padding: 10px;
        border-radius: 8px;
        background: #f0fdf4;
    }
    
    /* New Styles for buttons in merge modal */
    #mergeOptions {
        display: flex;
        flex-direction: column;
        gap: 10px;
    }

    /* --- Dark Mode & Language Add-on CSS --- */
    #addon-controls {
        position: fixed; bottom: 20px; left: 20px; z-index: 99999; display: flex; flex-direction: column; gap: 10px;
    }
    html[dir="ltr"] #addon-controls { left: auto; right: 20px; }
    .btn-addon { width: 45px; height: 45px; border-radius: 50%; border: none; color: white; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 10px rgba(0,0,0,0.2); cursor: pointer; }
    .btn-dark-toggle { background: #343a40; }
    .btn-lang-toggle { background: #6f42c1; }

    body.dark-mode { --bg-light: #121212; background-color: #121212; color: #e0e0e0; }
    body.dark-mode .mobile-header, body.dark-mode .stat-card, body.dark-mode .item-card, body.dark-mode .modal-content, body.dark-mode #exchangeRateContainer, body.dark-mode .dropdown-menu, body.dark-mode .input-group-text, body.dark-mode #searchInput { background-color: #1e1e1e !important; color: white !important; border-color: #333 !important; }
    body.dark-mode input.form-control, body.dark-mode .camera-trigger { background-color: #2d2d2d !important; color: white; border-color: #444; }
    body.dark-mode .badge-qty { background: #333; color: #eee; }
    body.dark-mode .text-muted { color: #aaa !important; }
    body.dark-mode .profit-calculator { background: #0d2b15; }

    /* Invoice processing styles */
    .invoice-processing-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.8);
        z-index: 10000;
        display: flex;
        justify-content: center;
        align-items: center;
        flex-direction: column;
        color: white;
    }
    
    .invoice-processing-overlay .spinner {
        width: 50px;
        height: 50px;
        border: 5px solid #f3f3f3;
        border-top: 5px solid #0f9b0f;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin-bottom: 20px;
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    
    .invoice-item {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 12px;
        margin-bottom: 10px;
        border-left: 4px solid #0f9b0f;
    }
    
    .invoice-item-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 8px;
    }
    
    .invoice-item-actions {
        display: flex;
        gap: 8px;
    }
    
    .confidence-badge {
        padding: 2px 8px;
        border-radius: 12px;
        font-size: 0.75rem;
        font-weight: bold;
    }
    
    .confidence-high { background: #d4edda; color: #155724; }
    .confidence-medium { background: #fff3cd; color: #856404; }
    .confidence-low { background: #f8d7da; color: #721c24; }
    
    .file-preview {
        max-width: 200px;
        max-height: 200px;
        border-radius: 8px;
        margin: 10px auto;
        display: block;
        object-fit: contain;
    }
    
    .ocr-text-preview {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 10px;
        margin-top: 10px;
        max-height: 150px;
        overflow-y: auto;
        font-size: 0.85rem;
        font-family: monospace;
    }
    
    .ai-powered-badge {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 5px 15px;
        border-radius: 20px;
        font-size: 0.8rem;
        font-weight: bold;
        display: inline-block;
        margin-bottom: 10px;
    }
</style>
</head>
<body>
<div id="loginSection">
    <div class="card p-4 text-center rounded-4 shadow" style="width: 90%; max-width: 320px;">
        <div class="mb-3 text-success"><i class="fas fa-mortar-pestle fa-3x"></i></div>
        <h4 class="fw-bold mb-1">إدارة مخزون الصيدلية</h4>
        <small class="text-muted mb-4">نظام ود المنسي - ماسح الفواتير الذكي</small>
        
        <input type="password" id="passInput" class="form-control text-center rounded-pill mb-3" placeholder="أدخل الرمز السري">
        <button onclick="attemptLogin()" class="btn btn-success w-100 rounded-pill fw-bold">تسجيل الدخول</button>
        <p id="loginError" class="text-danger mt-2 small d-none">كلمة المرور غير صحيحة</p>
    </div>
</div>

<div id="invoiceProcessingOverlay" class="invoice-processing-overlay d-none-custom">
    <div class="spinner"></div>
    <h4 id="processingStatus">جاري معالجة الفاتورة...</h4>
    <p id="processingDetails" class="small">يتم الآن تحليل الفاتورة باستخدام الذكاء الاصطناعي المتقدم</p>
    <div class="progress mt-3" style="width: 300px;">
        <div id="processingProgress" class="progress-bar progress-bar-striped progress-bar-animated" style="width: 0%"></div>
    </div>
</div>

<div id="mainDashboard" class="d-none-custom">
    
    <div class="mobile-header">
        <div class="dropdown">
            <button class="btn-tool" data-bs-toggle="dropdown">
                <i class="fas fa-cog"></i>
            </button>
            <ul class="dropdown-menu shadow border-0 rounded-3">
                <li><h6 class="dropdown-header">إدارة البيانات</h6></li>
                <li><a class="dropdown-item" href="#" onclick="backupData()"><i class="fas fa-download text-success"></i> نسخ احتياطي</a></li>
                <li><a class="dropdown-item" href="#" onclick="document.getElementById('restoreFile').click()"><i class="fas fa-upload text-primary"></i> استعادة</a></li>
                <li><hr class="dropdown-divider"></li>
                <li><a class="dropdown-item" href="#" onclick="document.getElementById('importExcelFile').click()"><i class="fas fa-file-excel text-success"></i> إضافة بيانات من Excel</a></li>
                <li><hr class="dropdown-divider"></li>
                <li><a class="dropdown-item text-danger" href="#" onclick="logout()"><i class="fas fa-sign-out-alt"></i> خروج</a></li>
            </ul>
            <input type="file" id="restoreFile" style="display:none" onchange="handleRestoreFile(this)" accept=".json">
            <input type="file" id="importExcelFile" style="display:none" onchange="handleImportExcelFile(this)" accept=".xlsx, .xls">
        </div>

        <h5 class="m-0 fw-bold text-success">إدارة مخزون الصيدلية</h5>

        <div class="header-buttons">
            <button onclick="openScanInvoiceModal()" class="btn-main btn-main-invoice">
                <i class="fas fa-file-invoice"></i> ماسح ذكي
            </button>
            <button onclick="openAddModal()" class="btn-main btn-main-add">
                <i class="fas fa-plus"></i> إضافة
            </button>
        </div>
    </div>

    <div class="container-fluid p-3 pb-5">
        
        <div id="exchangeRateContainer" class="d-flex align-items-center justify-content-between">
            <label for="exchangeRateInput" class="small fw-bold m-0 text-muted"><i class="fas fa-dollar-sign text-success"></i> سعر الدولار (SDG):</label>
            <input type="number" id="exchangeRateInput" onchange="updateExchangeRate(this.value)" class="form-control form-control-sm text-center" style="width: 100px;">
        </div>

        <div class="row g-2 mb-3">
            <div class="col-6">
                <div class="stat-card border-success" onclick="openChartModal('items')">
                    <i class="fas fa-pills text-success fa-2x mb-2 opacity-50"></i>
                    <h6 class="text-muted small mb-1">إجمالي الأصناف</h6>
                    <h4 class="fw-bold m-0" id="statCount">0</h4>
                </div>
            </div>
            <div class="col-6">
                <div class="stat-card border-primary" onclick="openChartModal('value')">
                    <i class="fas fa-coins text-primary fa-2x mb-2 opacity-50"></i>
                    <h6 class="text-muted small mb-1">القيمة الإجمالية</h6>
                    <h5 class="fw-bold m-0" id="statValue">0</h5>
                </div>
            </div>
            <div class="col-6">
                <div class="stat-card border-danger" onclick="openChartModal('expiry')">
                    <i class="fas fa-hourglass-half text-danger fa-2x mb-2 opacity-50"></i>
                    <h6 class="text-muted small mb-1">سينتهي قريباً</h6>
                    <h4 class="fw-bold m-0 text-danger" id="statExp">0</h4>
                </div>
            </div>
            <div class="col-6">
                <div class="stat-card border-warning" onclick="openChartModal('stock')">
                    <i class="fas fa-battery-quarter text-warning fa-2x mb-2 opacity-50"></i>
                    <h6 class="text-muted small mb-1">النواقص</h6>
                    <h4 class="fw-bold m-0 text-warning" id="statLow">0</h4>
                </div>
            </div>
        </div>

        <div class="input-group shadow-sm rounded-4 overflow-hidden bg-white mb-3">
            <span class="input-group-text bg-white border-0 ps-3"><i class="fas fa-search text-muted"></i></span>
            <input type="text" id="searchInput" onkeyup="renderList()" class="form-control border-0 p-2" placeholder="بحث بالاسم أو المادة الفعالة...">
        </div>

        <div id="inventoryContainer"></div>
    </div>
</div>

<!-- Modal إضافة العنصر -->
<div class="modal fade" id="itemModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content rounded-4 border-0">
            <div class="modal-header border-0">
                <h5 class="modal-title fw-bold">بيانات الدواء</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body pt-0">
                <div class="camera-trigger mb-3">
                    <i class="fas fa-camera fa-2x mb-2"></i><br>
                    <span>اضغط لتصوير العلبة (AI)</span>
                    <input type="file" class="camera-input" accept="image/*" capture="environment" onchange="handleOCR(this)">
                    <div id="ocrLoading" class="text-primary mt-2 small d-none">جاري قراءة البيانات...</div>
                </div>

                <input type="hidden" id="editIndex">
                <div class="form-floating mb-2">
                    <input type="text" class="form-control" id="inpName" placeholder="الاسم">
                    <label>اسم الدواء</label>
                </div>
                
                <div class="row g-2">
                    <div class="col-6">
                        <div class="form-floating mb-2">
                            <input type="number" class="form-control" id="inpQty" placeholder="الكمية">
                            <label>الكمية</label>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="form-floating mb-2">
                            <input type="number" class="form-control" id="inpBuyPrice" placeholder="الشراء" oninput="calculateProfit()">
                            <label>سعر الشراء</label>
                        </div>
                    </div>
                </div>
                
                <div class="profit-calculator mb-3">
                    <label for="profitRange" class="form-label small fw-bold text-success mb-1">
                        نسبة الربح: <span id="profitValue">20%</span>
                    </label>
                    <input type="range" class="form-range" min="1" max="100" value="20" id="profitRange" oninput="calculateProfit()">
                    <div class="form-floating">
                        <input type="number" class="form-control bg-white" id="inpPrice" placeholder="البيع" readonly>
                        <label>سعر البيع (محسوب)</label>
                    </div>
                </div>
                
                <div class="form-floating mb-2">
                    <input type="date" class="form-control" id="inpExp" placeholder="التاريخ">
                    <label>تاريخ الانتهاء</label>
                </div>
                <div class="form-floating">
                    <input type="text" class="form-control" id="inpActive" placeholder="المادة">
                    <label>المادة الفعالة (اختياري)</label>
                </div>
            </div>
            <div class="modal-footer border-0">
                <button onclick="saveItem()" class="btn btn-success w-100 rounded-pill py-2 fw-bold">حفظ البيانات</button>
                <button onclick="deleteItem()" id="btnDelete" class="btn btn-outline-danger w-100 rounded-pill py-2 d-none">حذف</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal دمج البيانات -->
<div class="modal fade" id="mergeModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content rounded-4 border-0">
            <div class="modal-header border-0">
                <h5 class="modal-title fw-bold">خيارات دمج البيانات</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p id="mergeMessage" class="lead text-center fw-bold"></p>
                <p class="text-muted small text-center">يرجى اختيار طريقة دمج الملف المستورد مع بياناتك الحالية:</p>
                <div id="mergeOptions">
                    <button onclick="processMerge('merge')" class="btn btn-outline-primary w-100">
                        <i class="fas fa-code-branch"></i> دمج (Merge): دمج الكميات وتحديث البقية
                    </button>
                    <button onclick="processMerge('add_new')" class="btn btn-outline-success w-100">
                        <i class="fas fa-plus-circle"></i> إضافة كأصناف جديدة
                    </button>
                    <button onclick="processMerge('replace')" id="replaceBtn" class="btn btn-outline-danger w-100">
                        <i class="fas fa-trash-alt"></i> استبدال (Replace): حذف كل البيانات الحالية واستبدالها
                    </button>
                </div>
                <small class="text-danger mt-3 d-block text-center">**تنبيه: زر الاستبدال سيحذف كل بياناتك الحالية.**</small>
            </div>
        </div>
    </div>
</div>

<!-- Modal مسح الفاتورة الذكي -->
<div class="modal fade" id="scanInvoiceModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content rounded-4 border-0">
            <div class="modal-header border-0">
                <h5 class="modal-title fw-bold"><i class="fas fa-robot me-2"></i>ماسح الفواتير الذكي</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body pt-0">
                <div class="ai-powered-badge">
                    <i class="fas fa-key me-2"></i>Active with Gemini
                </div>
                
                <div class="alert alert-info">
                    <i class="fas fa-brain me-2"></i>يقوم النظام بتحليل الفواتير باستخدام ذكاء اصطناعي متطور ودقيق (Gemini)
                </div>
                
                <div class="row g-3">
                    <div class="col-md-6">
                        <div class="camera-trigger mb-3" onclick="document.getElementById('invoiceFileInput').click()">
                            <i class="fas fa-file-invoice fa-3x mb-3 text-primary"></i><br>
                            <h5>رفع فاتورة</h5>
                            <p class="small text-muted">صورة أو PDF - يدعم العربية والإنجليزية</p>
                            <input type="file" id="invoiceFileInput" style="display:none" accept="image/*,.pdf,.jpg,.jpeg,.png" onchange="handleInvoiceFileSelect(this)">
                        </div>
                        
                        <div id="filePreviewContainer" class="d-none-custom">
                            <h6 class="text-center">معاينة الفاتورة:</h6>
                            <img id="filePreview" class="file-preview shadow-sm" src="" alt="معاينة الفاتورة">
                            <div class="text-center">
                                <button onclick="clearInvoiceFile()" class="btn btn-sm btn-outline-danger mt-2 rounded-pill"><i class="fas fa-trash me-1"></i> حذف الملف</button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-6">
                        <div class="form-floating mb-3">
                            <input type="text" class="form-control" id="invoiceNumber" placeholder="رقم الفاتورة">
                            <label><i class="fas fa-hashtag me-2"></i>رقم الفاتورة</label>
                        </div>
                        
                        <div class="form-floating mb-3">
                            <input type="date" class="form-control" id="invoiceDate" placeholder="تاريخ الفاتورة">
                            <label><i class="fas fa-calendar me-2"></i>تاريخ الفاتورة</label>
                        </div>
                        
                        <div class="form-floating mb-3">
                            <input type="text" class="form-control" id="supplierName" placeholder="اسم المورد">
                            <label><i class="fas fa-truck me-2"></i>اسم المورد (اختياري)</label>
                        </div>
                        
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="enableAIAnalysis" checked>
                            <label class="form-check-label" for="enableAIAnalysis">
                                <i class="fas fa-robot me-2"></i>تفعيل التحليل بالذكاء الاصطناعي
                            </label>
                        </div>
                    </div>
                </div>
                
                <div id="ocrTextPreview" class="ocr-text-preview d-none-custom mt-3">
                    <h6 class="mb-2"><i class="fas fa-search me-2"></i>النص المستخرج:</h6>
                    <div id="ocrTextContent" class="small"></div>
                </div>
                
                <div id="extractedItems" class="mt-4">
                    <h5 class="mb-3 d-none-custom" id="extractedTitle"><i class="fas fa-pills me-2"></i>الأدوية المستخرجة:</h5>
                    <div id="invoiceItemsList"></div>
                </div>
                
                <div class="mt-3 d-none-custom" id="invoiceSummary">
                    <div class="alert alert-success rounded-4">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <i class="fas fa-file-invoice-dollar me-2"></i>
                                <strong>ملخص الفاتورة:</strong>
                            </div>
                            <div>
                                <span id="totalItemsCount" class="badge bg-white text-success me-2">0 عنصر</span>
                                <span id="invoiceTotalAmount" class="fw-bold">0</span> SDG
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer border-0">
                <button onclick="startAIScanProcessing()" class="btn btn-primary w-100 rounded-pill py-2 fw-bold">
                    <i class="fas fa-bolt me-2"></i>بدء المسح الذكي
                </button>
                <button onclick="processInvoiceToInventory()" id="processInvoiceBtn" class="btn btn-success w-100 rounded-pill py-2 fw-bold d-none-custom">
                    <i class="fas fa-database me-2"></i>إضافة للمخزون
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal التقارير -->
<div class="modal fade" id="chartModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-fullscreen-sm-down">
        <div class="modal-content rounded-4">
            <div class="modal-header border-0">
                <h5 class="modal-title fw-bold" id="chartTitle">تحليل</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center">
                <h3 class="text-primary fw-bold mb-3" id="chartMainValue"></h3>
                
                <div style="height: 250px; margin-bottom: 20px;">
                    <canvas id="theChart"></canvas>
                </div>
                
                <div id="reportDetails" class="text-start">
                    <div class="d-flex justify-content-between align-items-center mb-2 border-bottom pb-1">
                        <h6 class="text-muted fw-bold m-0" id="reportHeader"></h6>
                        <button id="exportReportBtn" class="btn btn-sm btn-success d-none" onclick="exportDetailedReport()" title="تصدير للموقع">
                            <i class="fas fa-file-excel"></i> تصدير Excel
                        </button>
                    </div>
                    <ol id="detailedList" class="list-group list-group-numbered small"></ol>
                    <p class="mt-3 small text-muted" id="reportFooter"></p>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="addon-controls">
    <button class="btn-addon btn-dark-toggle" onclick="addon_toggleDark()">
        <i class="fas fa-moon" id="darkIcon"></i>
    </button>
    <button class="btn-addon btn-lang-toggle" onclick="addon_toggleLang()">
        <i class="fas fa-globe"></i>
    </button>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
    // --- 1. System Setup ---
    const SYS_PASS = "123456";
    // ⚠️ استبدل هذا المفتاح بمفتاح Google API الخاص بك ليعمل النظام (يبدأ بـ AIza...)
    const AI_API_KEY = "K83296860988957"; 
    
    let db = JSON.parse(localStorage.getItem('wm_db_v23')) || [];
    let chartInstance = null;
    let exchangeRate = localStorage.getItem('wm_exchange_rate') || 3000;
    let stagedData = null;
    let mergeContext = '';
    let extractedInvoiceItems = [];
    let currentInvoiceFile = null;
    let ocrWorker = null;
    let currentLang = 'ar';

    // PDF.js worker setup
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

    document.addEventListener('DOMContentLoaded', () => {
        document.getElementById('exchangeRateInput').value = exchangeRate;
        refreshUI();
        addon_init();
        initOCRWorker();
        console.log("✅ نظام ماسح الفواتير الذكي جاهز");
    });

    // --- 2. Authentication Logic ---
    function attemptLogin() {
        const pass = document.getElementById('passInput').value;
        if(pass === SYS_PASS) {
            document.getElementById('loginSection').classList.add('d-none-custom');
            document.getElementById('mainDashboard').classList.remove('d-none-custom');
            refreshUI();
        } else {
            document.getElementById('loginError').classList.remove('d-none');
        }
    }

    function logout() {
        if(confirm('تأكيد الخروج؟')) location.reload();
    }

    // --- 3. Core UI Functions ---
    function refreshUI() {
        renderList();
        calculateStats();
    }

    function updateExchangeRate(value) {
        exchangeRate = Number(value);
        localStorage.setItem('wm_exchange_rate', exchangeRate);
        calculateStats();
    }

    function renderList() {
        const container = document.getElementById('inventoryContainer');
        const term = document.getElementById('searchInput').value.toLowerCase();
        
        container.innerHTML = '';
        
        const filtered = db.filter(item => 
            item.name.toLowerCase().includes(term) || 
            (item.active && item.active.toLowerCase().includes(term))
        );

        if (filtered.length === 0) {
            container.innerHTML = `<div class="text-center text-muted mt-5"><i class="fas fa-box-open fa-3x mb-3"></i><p>لا توجد أصناف مطابقة</p></div>`;
            return;
        }

        filtered.forEach((item, index) => {
            const realIndex = db.indexOf(item);
            const daysLeft = Math.ceil((new Date(item.exp) - new Date()) / (1000*60*60*24));
            let statusIcon = '';
            let cardClass = '';
            
            if(daysLeft < 0) {
                statusIcon = '<i class="fas fa-skull text-danger ms-1" title="منتهي"></i>';
                cardClass = 'border-danger border-end border-3';
            } else if(daysLeft < 90) {
                statusIcon = '<i class="fas fa-exclamation-triangle text-warning ms-1" title="قريب"></i>';
                cardClass = 'border-warning border-end border-3';
            }

            container.innerHTML += `
                <div class="item-card ${cardClass}" onclick="openEditModal(${realIndex})">
                    <div>
                        <div class="fw-bold text-dark">${item.name} ${statusIcon}</div>
                        <small class="text-muted d-block">ينتهي: ${item.exp}</small>
                        ${item.source ? `<small class="text-info d-block" style="font-size:0.75rem"><i class="fas fa-file-invoice"></i> ${item.source}</small>` : ''}
                    </div>
                    <div class="text-end">
                        <span class="badge-qty">${item.qty}</span>
                        <div class="small fw-bold text-success mt-1">${Math.round(item.price * item.qty).toLocaleString()}</div>
                    </div>
                </div>
            `;
        });
    }

    function calculateStats() {
        document.getElementById('statCount').innerText = db.length;
        
        const totalValSDG = db.reduce((a,b) => a + (b.price * b.qty), 0);
        document.getElementById('statValue').innerText = formatMoney(totalValSDG);
        
        const today = new Date();
        const warningDate = new Date(); warningDate.setDate(today.getDate() + 90);
        const dangerCount = db.filter(i => new Date(i.exp) <= warningDate).length;
        document.getElementById('statExp').innerText = dangerCount;
        
        document.getElementById('statLow').innerText = db.filter(i => i.qty < 5).length;
    }

    function formatMoney(num) {
        if(num >= 1000000) return (num/1000000).toFixed(1) + 'M';
        if(num >= 1000) return (num/1000).toFixed(1) + 'K';
        return num.toLocaleString();
    }

    // --- 4. Profit Calculation ---
    function calculateProfit() {
        const buyPrice = Number(document.getElementById('inpBuyPrice').value);
        const profitPercentage = Number(document.getElementById('profitRange').value);
        
        document.getElementById('profitValue').innerText = profitPercentage + '%';

        if(buyPrice > 0) {
            const sellPrice = buyPrice + (buyPrice * profitPercentage / 100);
            document.getElementById('inpPrice').value = Math.round(sellPrice);
        } else {
            document.getElementById('inpPrice').value = 0;
        }
    }

    // --- 5. CRUD Operations ---
    function openAddModal() {
        document.getElementById('editIndex').value = '';
        document.getElementById('inpName').value = '';
        document.getElementById('inpQty').value = '';
        document.getElementById('inpBuyPrice').value = '';
        document.getElementById('inpPrice').value = '';
        document.getElementById('inpExp').value = '';
        document.getElementById('inpActive').value = '';
        document.getElementById('profitRange').value = 20;
        calculateProfit();
        document.getElementById('btnDelete').classList.add('d-none');
        const modal = new bootstrap.Modal(document.getElementById('itemModal'));
        modal.show();
    }

    function openEditModal(index) {
        const item = db[index];
        document.getElementById('editIndex').value = index;
        document.getElementById('inpName').value = item.name;
        document.getElementById('inpQty').value = item.qty;
        document.getElementById('inpBuyPrice').value = item.buyPrice || 0;
        document.getElementById('inpPrice').value = item.price;
        document.getElementById('inpExp').value = item.exp;
        document.getElementById('inpActive').value = item.active || '';
        
        // تقدير نسبة الربح إذا لم تكن مخزنة
        if(item.buyPrice && item.price) {
            let profit = Math.round(((item.price - item.buyPrice) / item.buyPrice) * 100);
            if(profit < 0) profit = 0;
            if(profit > 100) profit = 100;
            document.getElementById('profitRange').value = profit;
            document.getElementById('profitValue').innerText = profit + '%';
        }

        document.getElementById('btnDelete').classList.remove('d-none');
        const modal = new bootstrap.Modal(document.getElementById('itemModal'));
        modal.show();
    }

    function saveItem() {
        const idx = document.getElementById('editIndex').value;
        const name = document.getElementById('inpName').value;
        const qty = Number(document.getElementById('inpQty').value);
        const buyPrice = Number(document.getElementById('inpBuyPrice').value);
        const price = Number(document.getElementById('inpPrice').value);
        const exp = document.getElementById('inpExp').value;
        const active = document.getElementById('inpActive').value;

        if(!name || !qty || !price || !exp) {
            alert('يرجى تعبئة الحقول الأساسية');
            return;
        }

        const newItem = { name, qty, buyPrice, price, exp, active, lastUpdated: new Date().toISOString() };

        if(idx === '') {
            db.push(newItem);
        } else {
            db[Number(idx)] = newItem;
        }

        saveToLocal();
        refreshUI();
        bootstrap.Modal.getInstance(document.getElementById('itemModal')).hide();
    }

    function deleteItem() {
        const idx = document.getElementById('editIndex').value;
        if(idx !== '' && confirm('هل أنت متأكد من الحذف؟')) {
            db.splice(Number(idx), 1);
            saveToLocal();
            refreshUI();
            bootstrap.Modal.getInstance(document.getElementById('itemModal')).hide();
        }
    }

    function saveToLocal() {
        localStorage.setItem('wm_db_v23', JSON.stringify(db));
    }

    // --- 6. OCR & Tesseract (Single Item) ---
    async function initOCRWorker() {
        ocrWorker = await Tesseract.createWorker();
        await ocrWorker.loadLanguage('eng+ara');
        await ocrWorker.initialize('eng+ara');
    }

    async function handleOCR(input) {
        if(input.files && input.files[0]) {
            document.getElementById('ocrLoading').classList.remove('d-none');
            const file = input.files[0];
            const { data: { text } } = await Tesseract.recognize(file, 'eng', { logger: m => console.log(m) });
            
            // Simple logic to guess expiration date
            const expMatch = text.match(/(\d{2}\/\d{4})|(\d{2}-\d{4})|(\d{4}-\d{2}-\d{2})/);
            if(expMatch) {
                // Formatting needed... simple alert for now
                alert('تم اكتشاف تاريخ محتمل: ' + expMatch[0]);
            }
            
            document.getElementById('inpName').value = text.split('\n')[0].substring(0, 20); // Guess name
            document.getElementById('ocrLoading').classList.add('d-none');
        }
    }

    // --- 7. INVOICE SCANNING (GEMINI AI UPGRADE) ---
    
    function openScanInvoiceModal() {
        // Reset modal state
        currentInvoiceFile = null;
        extractedInvoiceItems = [];
        document.getElementById('invoiceFileInput').value = '';
        document.getElementById('filePreview').src = '';
        document.getElementById('filePreviewContainer').classList.add('d-none-custom');
        document.getElementById('ocrTextContent').innerText = '';
        document.getElementById('ocrTextPreview').classList.add('d-none-custom');
        document.getElementById('invoiceItemsList').innerHTML = '';
        document.getElementById('extractedTitle').classList.add('d-none-custom');
        document.getElementById('invoiceSummary').classList.add('d-none-custom');
        document.getElementById('processInvoiceBtn').classList.add('d-none-custom');
        document.getElementById('invoiceNumber').value = '';
        document.getElementById('invoiceDate').value = new Date().toISOString().split('T')[0];
        document.getElementById('supplierName').value = '';
        
        new bootstrap.Modal(document.getElementById('scanInvoiceModal')).show();
    }

    function handleInvoiceFileSelect(input) {
        if (input.files && input.files[0]) {
            currentInvoiceFile = input.files[0];
            const reader = new FileReader();
            
            if (currentInvoiceFile.type === 'application/pdf') {
                document.getElementById('filePreview').src = 'https://cdn-icons-png.flaticon.com/512/337/337946.png'; // PDF Icon
                document.getElementById('filePreviewContainer').classList.remove('d-none-custom');
            } else {
                reader.onload = function(e) {
                    document.getElementById('filePreview').src = e.target.result;
                    document.getElementById('filePreviewContainer').classList.remove('d-none-custom');
                };
                reader.readAsDataURL(currentInvoiceFile);
            }
        }
    }

    function clearInvoiceFile() {
        currentInvoiceFile = null;
        document.getElementById('invoiceFileInput').value = '';
        document.getElementById('filePreviewContainer').classList.add('d-none-custom');
    }

    // Helper: Convert File to Base64
    function fileToBase64(file) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = () => resolve(reader.result);
            reader.onerror = error => reject(error);
        });
    }

    // Helper: Convert PDF first page to Image Base64
    async function convertPdfToImage(pdfDataUrl) {
        const loadingTask = pdfjsLib.getDocument(pdfDataUrl);
        const pdf = await loadingTask.promise;
        const page = await pdf.getPage(1); // Get first page only
        const viewport = page.getViewport({ scale: 1.5 });
        const canvas = document.createElement('canvas');
        const context = canvas.getContext('2d');
        canvas.height = viewport.height;
        canvas.width = viewport.width;
        
        await page.render({ canvasContext: context, viewport: viewport }).promise;
        return canvas.toDataURL('image/jpeg');
    }

    async function startAIScanProcessing() {
        if (!currentInvoiceFile) {
            alert('يرجى اختيار ملف الفاتورة أولاً');
            return;
        }

        const overlay = document.getElementById('invoiceProcessingOverlay');
        const progressBar = document.getElementById('processingProgress');
        const statusText = document.getElementById('processingStatus');
        
        overlay.classList.remove('d-none-custom');
        progressBar.style.width = '10%';
        statusText.innerText = 'تحضير الملف...';

        try {
            // 1. Prepare Image Data
            let base64Data = await fileToBase64(currentInvoiceFile);
            
            if (currentInvoiceFile.type === 'application/pdf') {
                progressBar.style.width = '30%';
                statusText.innerText = 'تحويل PDF إلى صورة...';
                base64Data = await convertPdfToImage(base64Data);
            }
            
            // Clean Base64 string (remove data:image/jpeg;base64,)
            const base64Content = base64Data.split(',')[1];

            // 2. Prepare Gemini Request
            progressBar.style.width = '50%';
            statusText.innerText = 'الاتصال بـ Gemini AI...';

            const prompt = `
            You are an expert pharmacist assistant. Analyze this pharmacy invoice image carefully.
            Extract the data into a valid JSON object.
            
            Required JSON Structure:
            {
                "invoice_number": "string or empty",
                "invoice_date": "YYYY-MM-DD or empty",
                "supplier_name": "string or empty",
                "items": [
                    {
                        "name": "Trade Name of the medicine",
                        "scientific_name": "Generic Name (if visible, else empty)",
                        "qty": Number,
                        "unit_price": Number,
                        "expiry_date": "YYYY-MM-DD (if found, else null)"
                    }
                ]
            }
            
            Rules:
            1. If price is total, calculate unit price.
            2. Ignore non-medicine items if possible.
            3. Return ONLY the JSON object, no markdown formatting.
            `;

            // 3. Call Gemini API
            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${AI_API_KEY}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    contents: [{
                        parts: [
                            { text: prompt },
                            { inlineData: { mimeType: "image/jpeg", data: base64Content } }
                        ]
                    }]
                })
            });

            if (!response.ok) {
                const err = await response.json();
                throw new Error(err.error?.message || 'API Error');
            }

            progressBar.style.width = '80%';
            statusText.innerText = 'تحليل البيانات المستخرجة...';

            const result = await response.json();
            const textResponse = result.candidates[0].content.parts[0].text;
            
            // Clean Markdown if Gemini sends it
            const cleanJson = textResponse.replace(/```json|```/g, '').trim();
            const data = JSON.parse(cleanJson);

            // 4. Update UI with Data
            document.getElementById('invoiceNumber').value = data.invoice_number || '';
            if(data.invoice_date) document.getElementById('invoiceDate').value = data.invoice_date;
            document.getElementById('supplierName').value = data.supplier_name || '';
            
            extractedInvoiceItems = data.items || [];
            renderExtractedItems();
            
            progressBar.style.width = '100%';
            statusText.innerText = 'تمت المعالجة بنجاح!';
            
            setTimeout(() => {
                overlay.classList.add('d-none-custom');
                document.getElementById('extractedTitle').classList.remove('d-none-custom');
                document.getElementById('invoiceSummary').classList.remove('d-none-custom');
                document.getElementById('processInvoiceBtn').classList.remove('d-none-custom');
            }, 800);

        } catch (error) {
            console.error(error);
            overlay.classList.add('d-none-custom');
            alert('حدث خطأ أثناء المعالجة: ' + error.message + '\nتأكد من صلاحية مفتاح API.');
        }
    }

    function renderExtractedItems() {
        const list = document.getElementById('invoiceItemsList');
        list.innerHTML = '';
        let totalQty = 0;
        let totalAmount = 0;

        extractedInvoiceItems.forEach((item, index) => {
            const lineTotal = item.qty * item.unit_price;
            totalQty += item.qty;
            totalAmount += lineTotal;

            const div = document.createElement('div');
            div.className = 'invoice-item';
            div.innerHTML = `
                <div class="invoice-item-header">
                    <strong>${item.name}</strong>
                    <span class="badge bg-secondary">${item.qty} x ${item.unit_price}</span>
                </div>
                <div class="small text-muted mb-2">
                    ${item.scientific_name ? `<i>${item.scientific_name}</i> | ` : ''}
                    EXP: ${item.expiry_date || 'غير محدد'}
                </div>
                <div class="invoice-item-actions">
                    <input type="number" class="form-control form-control-sm" value="${item.qty}" onchange="updateExtractedItem(${index}, 'qty', this.value)" placeholder="الكمية">
                    <input type="number" class="form-control form-control-sm" value="${item.unit_price}" onchange="updateExtractedItem(${index}, 'unit_price', this.value)" placeholder="السعر">
                    <button class="btn btn-sm btn-outline-danger" onclick="removeExtractedItem(${index})"><i class="fas fa-times"></i></button>
                </div>
            `;
            list.appendChild(div);
        });

        document.getElementById('totalItemsCount').innerText = totalQty + ' عنصر';
        document.getElementById('invoiceTotalAmount').innerText = Math.round(totalAmount).toLocaleString();
    }

    function updateExtractedItem(index, field, value) {
        extractedInvoiceItems[index][field] = Number(value);
        renderExtractedItems();
    }

    function removeExtractedItem(index) {
        extractedInvoiceItems.splice(index, 1);
        renderExtractedItems();
    }

    function processInvoiceToInventory() {
        if(extractedInvoiceItems.length === 0) {
            alert('لا توجد عناصر للإضافة');
            return;
        }

        const supplier = document.getElementById('supplierName').value || 'فاتورة مستوردة';
        const invNum = document.getElementById('invoiceNumber').value;
        const sourceLabel = invNum ? `فاتورة ${invNum} - ${supplier}` : supplier;

        let addedCount = 0;
        extractedInvoiceItems.forEach(item => {
            db.push({
                name: item.name,
                qty: item.qty,
                buyPrice: item.unit_price,
                // Default profit margin logic
                price: Math.round(item.unit_price * 1.2), 
                exp: item.expiry_date || '2025-12-31', // Default exp if missing
                active: item.scientific_name,
                source: sourceLabel,
                lastUpdated: new Date().toISOString()
            });
            addedCount++;
        });

        saveToLocal();
        refreshUI();
        bootstrap.Modal.getInstance(document.getElementById('scanInvoiceModal')).hide();
        alert(`تمت إضافة ${addedCount} صنف للمخزون بنجاح!`);
    }

    // --- 8. Charts & Reports ---
    function openChartModal(type) {
        const ctx = document.getElementById('theChart').getContext('2d');
        if(chartInstance) chartInstance.destroy();
        
        let label = '';
        let labels = [];
        let data = [];
        let bgColor = '';
        let listHTML = '';

        if(type === 'items') {
            label = 'توزيع الكميات';
            document.getElementById('chartMainValue').innerText = db.length + ' صنف';
            document.getElementById('reportHeader').innerText = 'الأصناف الأعلى كمية';
            // Sort by qty desc
            const sorted = [...db].sort((a,b) => b.qty - a.qty).slice(0, 5);
            labels = sorted.map(i => i.name);
            data = sorted.map(i => i.qty);
            bgColor = '#198754';
            sorted.forEach(i => listHTML += `<li class="list-group-item d-flex justify-content-between align-items-start"><div class="ms-2 me-auto"><div class="fw-bold">${i.name}</div></div><span class="badge bg-success rounded-pill">${i.qty}</span></li>`);
        } else if(type === 'value') {
            label = 'القيمة (SDG)';
            const total = db.reduce((a,b) => a + (b.price * b.qty), 0);
            document.getElementById('chartMainValue').innerText = formatMoney(total);
            document.getElementById('reportHeader').innerText = 'الأعلى قيمة سوقية';
            const sorted = [...db].sort((a,b) => (b.price*b.qty) - (a.price*a.qty)).slice(0, 5);
            labels = sorted.map(i => i.name);
            data = sorted.map(i => i.price * i.qty);
            bgColor = '#0d6efd';
             sorted.forEach(i => listHTML += `<li class="list-group-item d-flex justify-content-between align-items-start"><div class="ms-2 me-auto"><div class="fw-bold">${i.name}</div></div><span class="badge bg-primary rounded-pill">${formatMoney(i.price*i.qty)}</span></li>`);
        } else if(type === 'expiry') {
             label = 'الأيام المتبقية';
             document.getElementById('chartMainValue').innerText = document.getElementById('statExp').innerText + ' خطر';
             document.getElementById('reportHeader').innerText = 'أقرب الأصناف لانتهاء الصلاحية';
             const sorted = [...db].filter(i => i.exp).sort((a,b) => new Date(a.exp) - new Date(b.exp)).slice(0, 5);
             labels = sorted.map(i => i.name);
             data = sorted.map(i => Math.ceil((new Date(i.exp) - new Date()) / (1000*60*60*24)));
             bgColor = '#dc3545';
             sorted.forEach(i => listHTML += `<li class="list-group-item d-flex justify-content-between align-items-start"><div class="ms-2 me-auto"><div class="fw-bold">${i.name}</div>ينتهي: ${i.exp}</div></li>`);
        } else if(type === 'stock') {
            label = 'الكمية';
            document.getElementById('chartMainValue').innerText = document.getElementById('statLow').innerText + ' نواقص';
            document.getElementById('reportHeader').innerText = 'أصناف شارفت على الانتهاء';
            const sorted = [...db].filter(i => i.qty < 5).sort((a,b) => a.qty - b.qty).slice(0, 5);
            labels = sorted.map(i => i.name);
            data = sorted.map(i => i.qty);
            bgColor = '#ffc107';
             sorted.forEach(i => listHTML += `<li class="list-group-item d-flex justify-content-between align-items-start"><div class="ms-2 me-auto"><div class="fw-bold">${i.name}</div></div><span class="badge bg-warning text-dark rounded-pill">${i.qty}</span></li>`);
        }

        chartInstance = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: label,
                    data: data,
                    backgroundColor: bgColor,
                    borderRadius: 5
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false
            }
        });

        document.getElementById('detailedList').innerHTML = listHTML;
        document.getElementById('exportReportBtn').classList.remove('d-none'); // Show export button
        new bootstrap.Modal(document.getElementById('chartModal')).show();
    }

    function exportDetailedReport() {
        const ws = XLSX.utils.json_to_sheet(db);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Inventory");
        XLSX.writeFile(wb, "Pharmacy_Inventory_Report.xlsx");
    }

    // --- 9. Data Management (Backup/Restore/Import) ---
    function backupData() {
        const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(db));
        const downloadAnchorNode = document.createElement('a');
        downloadAnchorNode.setAttribute("href", dataStr);
        downloadAnchorNode.setAttribute("download", "pharmacy_backup_" + new Date().toISOString().slice(0,10) + ".json");
        document.body.appendChild(downloadAnchorNode);
        downloadAnchorNode.click();
        downloadAnchorNode.remove();
    }

    function handleRestoreFile(input) {
        const file = input.files[0];
        if(!file) return;
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const data = JSON.parse(e.target.result);
                if(Array.isArray(data)) {
                    if(confirm(`هل تريد استعادة ${data.length} صنف؟ سيتم استبدال البيانات الحالية.`)) {
                        db = data;
                        saveToLocal();
                        refreshUI();
                    }
                } else {
                    alert('ملف غير صالح');
                }
            } catch(err) { alert('خطأ في قراءة الملف'); }
        };
        reader.readAsText(file);
    }

    function handleImportExcelFile(input) {
        const file = input.files[0];
        if(!file) return;
        const reader = new FileReader();
        reader.onload = function(e) {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, {type: 'array'});
            const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
            const jsonData = XLSX.utils.sheet_to_json(firstSheet);
            
            // Normalize Data
            stagedData = jsonData.map(row => ({
                name: row.name || row['الاسم'] || row['Item'] || 'Unknown',
                qty: Number(row.qty || row['الكمية'] || row['Quantity'] || 0),
                price: Number(row.price || row['السعر'] || row['Price'] || 0),
                exp: row.exp || row['التاريخ'] || row['Expiry'] || '2025-01-01',
                buyPrice: 0,
                active: ''
            }));

            document.getElementById('mergeMessage').innerText = `تم العثور على ${stagedData.length} صنف في الملف`;
            new bootstrap.Modal(document.getElementById('mergeModal')).show();
        };
        reader.readAsArrayBuffer(file);
    }

    function processMerge(type) {
        if(!stagedData) return;
        
        if(type === 'replace') {
            if(confirm('سيتم حذف جميع البيانات الحالية! هل أنت متأكد؟')) {
                db = stagedData;
            }
        } else if(type === 'add_new') {
            db = [...db, ...stagedData];
        } else if(type === 'merge') {
            stagedData.forEach(newItem => {
                const existing = db.find(item => item.name === newItem.name);
                if(existing) {
                    existing.qty += newItem.qty; // Just add qty
                } else {
                    db.push(newItem);
                }
            });
        }
        
        saveToLocal();
        refreshUI();
        bootstrap.Modal.getInstance(document.getElementById('mergeModal')).hide();
        stagedData = null;
    }

    // --- 10. Addons (Dark Mode & Lang) ---
    function addon_init() {
        if(localStorage.getItem('wm_dark_mode') === 'true') {
            document.body.classList.add('dark-mode');
            document.getElementById('darkIcon').className = 'fas fa-sun';
        }
    }

    function addon_toggleDark() {
        document.body.classList.toggle('dark-mode');
        const isDark = document.body.classList.contains('dark-mode');
        localStorage.setItem('wm_dark_mode', isDark);
        document.getElementById('darkIcon').className = isDark ? 'fas fa-sun' : 'fas fa-moon';
    }

    function addon_toggleLang() {
        const html = document.documentElement;
        if(html.getAttribute('dir') === 'rtl') {
            html.setAttribute('dir', 'ltr');
            html.setAttribute('lang', 'en');
            // Basic text replacements could go here
        } else {
            html.setAttribute('dir', 'rtl');
            html.setAttribute('lang', 'ar');
        }
    }
</script>
</body>
</html>
